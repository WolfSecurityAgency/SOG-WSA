<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Clients Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding:20px }
    table { border-collapse: collapse; width: 100%; max-width:800px }
    th,td { border:1px solid #ddd; padding:8px; text-align:left }
    th { background:#f2f2f2 }
    .offline { color: #999 }
  </style>
</head>
<body>
  <h2>Connected Clients</h2>
  <p>Auto-scans the Realtime DB and shows clients with a recent heartbeat (last 40s).</p>
  <table id="tbl">
    <thead><tr><th>Device ID</th><th>Hostname</th><th>Platform</th><th>Last heartbeat (UTC)</th><th>Status</th></tr></thead>
    <tbody id="rows"><tr><td colspan="5">Loadingâ€¦</td></tr></tbody>
  </table>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ======= PASTE YOUR FIREBASE CONFIG HERE =======
    // Replace the object below with your web app config from Firebase console
    const firebaseConfig = {
      apiKey: "PASTE_API_KEY",
      authDomain: "PROJECT.firebaseapp.com",
      databaseURL: "https://PROJECT.firebaseio.com",
      projectId: "PROJECT",
      storageBucket: "PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    // ===============================================

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const rowsEl = document.getElementById('rows');
    const HEARTBEAT_WINDOW_SEC = 40; // consider clients online within last 40s

    function render(clients) {
      const now = Date.now();
      if (!clients) {
        rowsEl.innerHTML = '<tr><td colspan="5">No clients</td></tr>';
        return;
      }
      const keys = Object.keys(clients).sort();
      if (!keys.length) {
        rowsEl.innerHTML = '<tr><td colspan="5">No clients</td></tr>';
        return;
      }
      rowsEl.innerHTML = '';
      for (const id of keys) {
        const c = clients[id] || {};
        const ts = c.last_heartbeat || 0;
        const age = (now - ts) / 1000.0;
        const online = age <= HEARTBEAT_WINDOW_SEC;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(id)}</td>
          <td>${escapeHtml(c.hostname || '')}</td>
          <td>${escapeHtml(c.platform || '')}</td>
          <td>${ts ? new Date(ts).toISOString() : ''}</td>
          <td class="${online ? '' : 'offline'}">${online ? 'online' : 'offline'}</td>
        `;
        rowsEl.appendChild(tr);
      }
    }

    // helper
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]))}

    // Read full clients subtree and re-render on changes
    const clientsRef = db.ref('clients');
    clientsRef.on('value', snapshot => {
      render(snapshot.val());
    });

    // Optional: poll every 10s to update status coloring (in case timestamps age)
    setInterval(()=> {
      clientsRef.once('value').then(snap => render(snap.val()));
    }, 10000);

  </script>
</body>
</html>
